<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webhook Data Syncing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" defer></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-500 to-purple-600 font-sans text-gray-900">

<div class="max-w-7xl mx-auto p-6">

    <!-- Header -->
    <header class="text-center mb-8 relative">
        <h1 class="text-4xl md:text-5xl font-bold text-white drop-shadow-lg flex justify-center items-center gap-2">
            <i class="fas fa-broadcast-tower"></i> Webhook
        </h1>
        <p class="text-white/80 mt-2">Real-time webhook monitoring and data visualization</p>
        <div class="mt-4">
            <a href="/index.html" class="inline-block px-4 py-2 rounded-full border border-white/40 bg-white/20 text-white backdrop-blur-md hover:bg-white/30 shadow transition">
                üè† Back to Home
            </a>
        </div>
    </header>

    <!-- Statistics -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="bg-white/95 rounded-xl shadow p-6 text-center hover:shadow-2xl transition">
            <div id="totalWebhooks" class="text-3xl font-bold text-indigo-600">0</div>
            <div class="uppercase text-gray-500 font-semibold mt-1">Total Webhooks</div>
        </div>
        <div class="bg-white/95 rounded-xl shadow p-6 text-center hover:shadow-2xl transition">
            <div id="todayWebhooks" class="text-3xl font-bold text-indigo-600">0</div>
            <div class="uppercase text-gray-500 font-semibold mt-1">Today</div>
        </div>
        <div class="bg-white/95 rounded-xl shadow p-6 text-center hover:shadow-2xl transition">
            <div id="lastHour" class="text-3xl font-bold text-indigo-600">0</div>
            <div class="uppercase text-gray-500 font-semibold mt-1">Last Hour</div>
        </div>
        <div class="bg-white/95 rounded-xl shadow p-6 text-center hover:shadow-2xl transition">
        <span class="inline-flex items-center gap-1 bg-green-100 text-green-600 px-3 py-1 rounded-full font-semibold uppercase text-sm">
          <i class="fas fa-circle"></i> Live
        </span>
            <div class="uppercase text-gray-500 font-semibold mt-1">Status</div>
        </div>
    </div>

    <!-- Configuration & System Info -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <!-- API Configuration -->
        <div class="bg-white/95 rounded-xl shadow p-6 hover:shadow-2xl transition">
            <h3 class="text-xl font-semibold flex items-center gap-2 mb-4">
                <i class="fas fa-cog"></i> API Configuration
            </h3>
            <form id="configForm" class="space-y-4">
                <div>
                    <label for="apiUrl" class="block text-sm font-medium text-gray-700">API Base URL</label>
                    <input type="url" id="apiUrl" placeholder="https://api.example.com" required
                           class="mt-1 w-full rounded-lg border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2 text-sm">
                </div>
                <div>
                    <label for="apiToken" class="block text-sm font-medium text-gray-700">API Token</label>
                    <input type="password" id="apiToken" placeholder="Enter your API token" required
                           class="mt-1 w-full rounded-lg border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2 text-sm">
                </div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                    <i class="fas fa-save"></i> Save Configuration
                </button>
            </form>
            <div id="configMsg" class="mt-4"></div>
        </div>

        <!-- System Information -->
        <div class="bg-white/95 rounded-xl shadow p-6 hover:shadow-2xl transition">
            <h3 class="text-xl font-semibold flex items-center gap-2 mb-4">
                <i class="fas fa-info-circle"></i> System Information
            </h3>
            <div class="space-y-3">
                <div class="flex justify-between">
                    <span class="text-gray-500">Last Updated:</span>
                    <span id="lastUpdated">Never</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">Refresh Interval:</span>
                    <span>5 seconds</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">Connection:</span>
                    <span class="inline-flex items-center gap-1 bg-green-100 text-green-600 px-3 py-1 rounded-full font-semibold uppercase text-sm">
              <i class="fas fa-wifi"></i> Connected
            </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Webhook Data Table -->
    <div class="bg-white/95 rounded-xl shadow overflow-x-auto hover:shadow-2xl transition">
        <div class="flex justify-between items-center p-6 border-b border-gray-200 bg-gray-50">
            <h3 class="text-xl font-semibold flex items-center gap-2"><i class="fas fa-database"></i> Order Data</h3>
            <div id="refreshIndicator" class="flex items-center gap-2 text-gray-500">
                <i class="fas fa-sync-alt animate-spin"></i>
                <span>Auto-refresh active</span>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse min-w-max">
                <thead class="bg-gray-50">
                <tr>
                    <th class="p-3 uppercase text-xs font-semibold text-gray-700 whitespace-nowrap">ID</th>
                    <th class="p-3 uppercase text-xs font-semibold text-gray-700 whitespace-nowrap">Display #</th>
                    <th class="p-3 uppercase text-xs font-semibold text-gray-700 whitespace-nowrap">Subsidiary</th>
                    <th class="p-3 uppercase text-xs font-semibold text-gray-700 whitespace-nowrap">Type</th>
                    <th class="p-3 uppercase text-xs font-semibold text-gray-700 whitespace-nowrap">Delivery Mode</th>
                    <th class="p-3 uppercase text-xs font-semibold text-gray-700 whitespace-nowrap">BL #</th>
                    <th class="p-3 uppercase text-xs font-semibold text-gray-700 whitespace-nowrap">Notes</th>
                    <th class="p-3 uppercase text-xs font-semibold text-gray-700 whitespace-nowrap">Transporter Booking #</th>
                    <th class="p-3 uppercase text-xs font-semibold text-gray-700 whitespace-nowrap">Transporter Name</th>
                </tr>
                </thead>
                <tbody id="dataTable">
                <tr>
                    <td colspan="9" class="text-center text-gray-400 py-12">
                        <i class="fas fa-inbox text-4xl mb-2 block"></i>
                        <div>No webhook data available</div>
                        <small>Configure your API settings and start receiving webhooks</small>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

</div>

<script>
    let webhookStats = { total:0, today:0, lastHour:0 };

    // Define the fields we want to display
    const DISPLAY_FIELDS = [
        'id', 'displayNumber', 'subsidiary', 'type', 'orderDeliveryMode',
        'blNumber', 'notes', 'transporterBookingNo', 'transporterName'
    ];

    document.getElementById('configForm').addEventListener('submit', async e => {
        e.preventDefault();
        const btn = e.target.querySelector('button[type="submit"]');
        const original = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...'; btn.disabled = true;

        const apiUrl = document.getElementById('apiUrl').value;
        const apiToken = document.getElementById('apiToken').value;

        try {
            const res = await fetch('/set-config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ apiUrl, apiToken })
            });
            const data = await res.json();
            const msgDiv = document.getElementById('configMsg'); msgDiv.innerHTML='';
            const alert = document.createElement('div');
            alert.className = `p-4 rounded ${data.success?'bg-green-100 text-green-600':'bg-red-100 text-red-600'} flex items-center gap-2`;
            alert.innerHTML = `<i class="fas ${data.success?'fa-check-circle':'fa-exclamation-triangle'}"></i> ${data.success?'Configuration saved successfully!':'Error saving configuration.'}`;
            msgDiv.appendChild(alert);
            if(data.success){ setTimeout(()=>{ alert.remove(); }, 3000);}
        } catch(e){ console.error(e); }
        finally{ btn.innerHTML=original; btn.disabled=false;}
    });

    // Function to remove duplicates and keep only the latest updated record
    function removeDuplicates(data) {
        const uniqueMap = new Map();

        data.forEach(item => {
            const id = item.id || item.resourceId || item._id;
            const updatedAt = new Date(item.data.updatedAt || item.data.updated_at || item.data.modifiedAt || item.receivedAt || Date.now());

            if (!uniqueMap.has(id) || updatedAt > uniqueMap.get(id).updatedDate) {
                uniqueMap.set(id, {
                    ...item,
                    updatedDate: updatedAt
                });
            }
        });

        return Array.from(uniqueMap.values()).sort((a, b) => b.updatedDate - a.updatedDate);
    }

    // Function to extract and format field value
    function getFieldValue(item, field) {
        const data = item.data || {};
        // Try different possible field names
        const possibleNames = [
            field,
            field.toLowerCase(),
            field.replace(/([A-Z])/g, '_$1').toLowerCase(),
            field.replace(/([a-z])([A-Z])/g, '$1_$2').toLowerCase()
        ];

        let value = null;
        for (const name of possibleNames) {
            if (data[name] !== undefined && data[name] !== null) {
                value = data[name];
                break;
            }
        }
        // also check in root item
        if (value === null) {
            for (const name of possibleNames) {
                if (item[name] !== undefined && item[name] !== null) {
                    value = item[name];
                    break;
                }
            }
        }


        if (value === null || value === undefined) {
            return '-';
        }

        return String(value);
    }

    async function loadData(){
        const refreshIndicator = document.getElementById('refreshIndicator');
        refreshIndicator.classList.add('text-indigo-600');

        try{
            const res = await fetch('/get-data');
            const json = await res.json();
            const tbody = document.getElementById('dataTable');

            if(json.success && json.results && json.results.length){
                // Remove duplicates and keep only latest
                const uniqueData = removeDuplicates(json.results);

                tbody.innerHTML='';
                webhookStats.total = uniqueData.length;
                webhookStats.today = uniqueData.filter(i=>isToday(i.updatedDate)).length;
                webhookStats.lastHour = uniqueData.filter(i=>isLastHour(i.updatedDate)).length;
                updateStats();

                uniqueData.forEach(item=>{
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-100 hover:bg-gray-50 transition-colors';

                    const cells = DISPLAY_FIELDS.map(field => {
                        const value = getFieldValue(item, field);
                        return `<td class="p-3 text-sm whitespace-nowrap">${value}</td>`;
                    }).join('');

                    row.innerHTML = cells;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML=`<tr><td colspan="9" class="text-center text-gray-400 py-12">
                    <i class="fas fa-inbox text-4xl mb-2 block"></i>
                    <div>No webhook data available</div>
                    <small>Configure your API settings and start receiving webhooks</small>
                </td></tr>`;
                updateStats();
            }
            document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
        } catch(e){
            console.error('Error loading data:', e);
            const tbody = document.getElementById('dataTable');
            tbody.innerHTML=`<tr><td colspan="9" class="text-center text-red-400 py-12">
                <i class="fas fa-exclamation-triangle text-4xl mb-2 block"></i>
                <div>Error loading webhook data</div>
                <small>Please check your API configuration and connection</small>
            </td></tr>`;
        }
        finally{ refreshIndicator.classList.remove('text-indigo-600'); }
    }

    function updateStats(){
        document.getElementById('totalWebhooks').textContent = webhookStats.total;
        document.getElementById('todayWebhooks').textContent = webhookStats.today;
        document.getElementById('lastHour').textContent = webhookStats.lastHour;
    }

    function isToday(date){
        if (!date) return false;
        const d=new Date(date); const t=new Date();
        return d.toDateString()===t.toDateString();
    }
    function isLastHour(date){
        if (!date) return false;
        const d=new Date(date);
        return d>=new Date(Date.now()-3600000);
    }

    setInterval(loadData,5000);
    loadData();
</script>

</body>
</html>
